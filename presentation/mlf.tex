\section{Иерархические обобщенные линейные модели}


\subsection{Определение MLF}

Для начала, стоит определиться, какие переменные мы рассматриваем как многоуровневые (multi-level). 
Мы будем называть фактор многоуровневым, если он имеет относительно большое количество уровней, многие из которых не имеют много данных, при этом, уровни фактора не имеют никакого естественного порядка. 
Приведём несколько примеров:



\begin{itemize}
	\item Населённый пункт. Является одним из самых важных факторов. Через него могут внести эффект такие показатели, например, как качество дорог, по которым ездит страхователь, качество жизни горожан. Такие показатели имеют сильное влияние и их учёт сильно повышает качество модели. Но здесь мы сталкиваемся с проблемой. В состав Российской Федерации входит более тысячи городов. При этом, лишь по нескольким из них имеется достаточная статистика.
	Можно было бы объеденить все небольшие города в один из одного региона или даже федерального округа для избежания небольших объёмов данных, но это приводит к другим проблемам: населённый пункт с большим средним доходом было бы неправильно объединять с неблагополучным соседним. Было бы разумнее объединить его  с похожим населённым пунктом из другого региона. Поэтому этот фактор остаётся многоуровневым.
	\item Модель автомобиля. Это один из самых важных факторов в тарификации тоже. Здесь возникают проблемы схожие с населённым пунктом. Какие-то модели более привлекательны для угона, какие-то редкие модели дороже ремонтировать при обычных ДТП, или владельцы каких-то марок более склонны к тем или иным ДТП. Очевидно, уровни фактора не образуют никакого естественного порядка. При этом их очень много и лишь несколько самых популярных из них имеют не слишком маленькую долю.

\end{itemize}
	В примере с населённым пунктом была поставлена основная проблема. Есть некоторые уровни многоуровневого фактора, которые неправильно было бы учитывать обычным для обобщенных линейных моделей образом, поскольку для них слишком мало статистики. Но но не учитывать их совсем тоже неправильно, если они имеют большой эффект. Здесь нам нужно найти некоторый компромисс между этими подходами. 
	ОЛМ содержащие хотя бы один многоуровневый фактор мы будем называть \textit{иерархическими}
	

\newpage	
	
\subsection{Частичное решение проблем MLF}
	
	Проблемы малых групп, описанные выше, могут быть решены использованием других факторов, которые объясняют влияние данного MLF. Например, для многоуровневого фактора 'Модель авто' такими факторами могут являться 'Мощность', 'Страховая сумма', 'Количество мест', 'Класс ТС', 'Масса ТС' и так далее. Такие характеристики автомобиля хорошо объясняют 'индивидуальность' данной модели. Более того, 'Мощность' и 'Страховая сумма' дают немного более широкое данные, т.к. у моделей существуют различные комплектации. Этот подход улучшает предсказательную силу модели. Но, как показывает практика не всегда описывает всю картину. Рассмотрим сказанное на примере.
	
	Рассмотрим модель частоты ДТП Виновник. Посмотрим на распределение частот по моделям. Попробуем включить в модель все имеющиеся факторы, кроме многоуровневых 'Модель авто' и 'Населённый пункт'.
	
	\includegraphics[scale=0.5]{data/models_explained/distr_model_1_15}
	\includegraphics[scale=0.5]{data/models_explained/distr_model_16_30}
	\includegraphics[scale=0.5]{data/models_explained/distr_model_31_45}		

На графиках видно, что эти факторы хорошо объясняют влияние 'Модель авто'. Поэтому, нет нужды использовать этот фактор, как многоуровневый. Достаточно выделить, несколько моделей, влияние которых плохо объяснилось в отдельные группы и использовать как обычный фактор. При этой группировки стоит помнить про фактор 'Марка авто'. 



Теперь посмотрим, как объяснился фактор 'Населённый пункт'.

	\includegraphics[scale=0.5]{data/cites_not_explained/distr_cities_1_15}
	\includegraphics[scale=0.5]{data/cites_not_explained/distr_cities_16_30}
	\includegraphics[scale=0.5]{data/cites_not_explained/distr_cities_31_45}

К сожалению, для фактора 'Населённый пункт' нет таких же факторов, которые бы хорошо его объясняли. Конечно, какое-то объяснение присутствует, но мы будем вынужденны использовать данный фактор, как многоуровневый.


\include{credibility_theory}


\section{Пример использования MLF}

Покажем, какие результаты даёт правильная работа с многоуровневыми факторами. Для этого рассмотрим модель частоты ДТП Виновник. Случайным образом разделим все денные на две части: 70\% для обучающей выборки и 30\% для тестовой выборки. На тестовой выборке мы попробуем построить две модели, которые будут отличаться лишь использованием многоуровневого фактора. первая будет использовать этот фактор обычным для ОЛМ образом, а вторая, как многоровневый фактор с помощью описанного выше алгоритма. Затем мы сравним предсказания обоих моделей с тестовой выборкой по всем городам. В качестве многоуровневого фактора возьмём 'Город'.

Для фактора 'Город' были получены следующие результаты:


Сравнение результатов на первых 15 городах по экспозиции:

	\includegraphics[scale=0.5]{data/mlf/distr_city_1_15_comp}

Сравнение результатов на последних 15 городах по экспозиции:

	\includegraphics[scale=0.5]{data/mlf/distr_city_16_30_comp}

На 15 самых распространенных городах преимущество использование многоуровневого фактора проявляется не так сильно. Это объясняется тем, что для данных городов имеется достаточно много наблюдений и эти два подхода 
не сильно различаются. 

Но на 15 самых нераспространенных городов использование многоуровневого фактора показывает лучше результаты. 


Для каждого уровня $j$ фактора $F$ будет удобно воспользоваться известными смещениями $\xi_i$, чтобы задать соответствующее значение. Данный алгоритм следует применять в последнюю очередь, после того, как модель построена на остальных, немногоуровневых факторов. Может так оказаться, что этот многоуровневый фактор объясняется другими переменными.